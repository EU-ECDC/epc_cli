#!/usr/bin/env python

import sys
sys.path.insert(0, '.')
import re
import argparse
import keyring
import getpass
import epc_cli
import logging
from keyrings.cryptfile.cryptfile import CryptFileKeyring

# activate cryptfile backend
kr = CryptFileKeyring()
keyring.set_keyring(kr)

parser = argparse.ArgumentParser()
parser.add_argument("-c", "--config", 
                    type=str, 
                    help="path to configuration file",
                    required=True)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s: %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

args = parser.parse_args()
config_data = epc_cli.load_config(args.config)
user_name = config_data['credentials']['username']
env_name = config_data['env']['name']

print(f'Configuring credentials for user {user_name}')


master_pwd = getpass.getpass("Please set/type the master password for the keyring: ")
kr.keyring_key = master_pwd
print(f'Got it! Thanks')
print()


pwd_input = getpass.getpass(f"Now enter the password for your EpiPulse user ({user_name}): ")
keyring.set_password(f"epc-cli_{env_name}_psswd", user_name, pwd_input)
print(f"Keyring updated successfully [EPC password]")
print()

clientid_input = getpass.getpass(f"Please enter the client_id: ")
keyring.set_password(f"epc-cli_{env_name}_client-id", user_name, clientid_input)
print(f'Keyring updated successfully [client_id]')
print()

print(f'Configuration of credentials for user {user_name} complete')
print(f'You can now use epc_cli!')


