#!/usr/bin/env python

import sys
sys.path.insert(0, '.')
import re
import argparse
import keyring
import getpass
import epc_cli
import logging
import hashlib
import secrets
import logging
import os
from keyrings.cryptfile.cryptfile import CryptFileKeyring

parser = argparse.ArgumentParser()
parser.add_argument("-c", "--config", 
                    type=str, 
                    help="path to configuration file",
                    required=True)
parser.add_argument("-k", "--kr_path", 
                    type=str, 
                    help="path to the keyring")

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s: %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

args = parser.parse_args()
logging.info("Reading configuration file")
config_data = epc_cli.load_config(args.config)
user_name = config_data['credentials']['username']
env_name = config_data['env']['name']
print(f"- Environment: {env_name}; User: {user_name}")
print()

logging.info("Creating application data folder")
os.makedirs(config_data['application_data'], exist_ok=True)
print()

logging.info("Creating/Accesing the keyring")
kr = CryptFileKeyring()
# if args does not have a kr_path attr it returns None to "if"
if getattr(args, "kr_path", None):
    kr.file_path = args.kr_path
print(f"- Keyring path: {kr.file_path}")

if not os.path.exists(kr.file_path):
    random_bytes = secrets.token_bytes(32)
    random_hash = hashlib.sha256(random_bytes).hexdigest()
    kr.keyring_key = random_hash
    print(f"Generating a master password for the keyring:\n{random_hash}")
    print("⚠️ Please store this value in a secure location. It will not be shown again.")
    print()
else:
    print(f"Action: adding new secrets to an existing the keyring")
    print()

keyring.set_keyring(kr)

logging.info("Storing secrets")
pwd_input = getpass.getpass(f"Now enter the password for your EpiPulse user [{user_name}]: ")
keyring.set_password(f"epc-cli_{env_name}_psswd", user_name, pwd_input)
print(f"- Keyring updated successfully [EPC password]")
print()

clientid_input = getpass.getpass(f"Please enter the client_id: ")
keyring.set_password(f"epc-cli_{env_name}_client-id", user_name, clientid_input)
print(f'- Keyring updated successfully [client_id]')
print()
