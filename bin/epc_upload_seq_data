#!/usr/bin/env python

import sys
sys.path.insert(0, '.')
import re
import argparse
import epc_cli
import glob
import logging

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] - %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

# Function to validate the country code format (ISO 3166-1 alpha-2)
def validate_country_code(value):
    if not re.fullmatch(r"[A-Z]{2}", value):
        raise argparse.ArgumentTypeError(f"Invalid country code: {value}. Expected format: IT, SE, DE")
    return value

parser = argparse.ArgumentParser()
parser.add_argument("-c", "--config", type=str, default="config.json",
                    help="path to configuration file")
parser.add_argument("-s", "--subject", type=str,
                    help="Subject code (e.g. LEGIISO)", required=True)
parser.add_argument("-cc", "--country_code", type=str,
                    help="Country code (ISO 3166-1 alpha-2, e.g., IT, SE, DE)", required=True)
parser.add_argument("-f", "--files", type=str, nargs='+',
                    help="List of files to process [space-separated]", required=True)
args = parser.parse_args()


# Expand wildcards
expanded_files = []
for pattern in args.files:
    expanded_files.extend(glob.glob(pattern))  # Expand each pattern

if not expanded_files:
    print("Error: No matching files found for the provided pattern(s).")
    exit(1)

config_data = epc_cli.load_config(args.config)

t = epc_cli.request_token(config_data)
print()

for f in expanded_files:
    a = epc_cli.get_s3_presigned_url(t, config_data, args.subject, args.country_code, f)
    print()
    #print("pre-signed url: {}".format(a['fileName']))
    epc_cli.upload_with_presigned_url(f, a['fileName'])
    print()

