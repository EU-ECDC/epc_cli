#!/usr/bin/env python

import sys
sys.path.insert(0, '.')
import re
import argparse
import epc_cli
import glob
import logging
import time
import json

parser = argparse.ArgumentParser()
parser.add_argument("-c", "--config", type=str, default="config.json",
                    help="path to configuration file")
parser.add_argument("-g", "--guid", type=str,
                    help="GUID of the uploaded csv/xml", required=True)
args = parser.parse_args()


logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s: %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)



max_attempts = 10

config_data = epc_cli.load_config(args.config)

t = None
if epc_cli.is_token_potentially_valid(config_data):
    t = epc_cli.read_token(config_data)
else:
    t = epc_cli.request_token(config_data)
print()

a = 1
tl = epc_cli.get_upload_timeline(t, config_data, args.guid)
print()
#print(json.dumps(tl))
if (tl['timeLineSteps'][-1]["statusDescription"] == "ISO file validation successful") or (tl['timeLineSteps'][-1]["statusDescription"] == "Tech validation successful"):
    vdata = epc_cli.start_epidemiological_validation(t, config_data, args.guid)
    print("    Started: {}".format(vdata["isSuccessful"]))
    print("    resultMessage: {}".format(vdata["resultMessage"]))
    print("    Epidemiological Validation GUID: {}".format(vdata["taskCorrelationGuid"]))
    print()
    if vdata["isSuccessful"] == True:
        generating_report = True
        while(generating_report):
            tl2 = epc_cli.get_upload_timeline(t, config_data, args.guid)
            #print(f"    Attempt {a}")
            print()
            if tl2['timeLineSteps'][-1]["statusDescription"] == "Data validation report ready":
                break
            if tl2['timeLineSteps'][-1]["statusDescription"] == "Data validation failed":
                print("ERROR: data validation failed")
                sys.exit(81)
            if a > max_attempts:
                print("ERROR: exceeded maximum number of attempts")
                sys.exit()
            a = a + 1
            time.sleep(60)
        epc_cli.get_epidemiological_validation_report(t, config_data, vdata['taskCorrelationGuid'], f"{config_data['application_data']}/submissions/{args.guid}/report.html")

else:
    raise Exception("ERROR: You are in a state where you should not trigger an epidemiological validation")




