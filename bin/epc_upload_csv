#!/usr/bin/env python3

import sys
sys.path.insert(0, '.')
import os
import argparse
import json
import epc_cli
import glob
import time
import logging
import datetime
from logging.handlers import MemoryHandler
import csv

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s - %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S",
)

logger = logging.getLogger()
console_handler = logging.StreamHandler(sys.stdout)  # Log to console

def validate_date(date_str):
    try:
        return datetime.datetime.strptime(date_str, "%Y-%m-%d").date()
    except ValueError:
        raise argparse.ArgumentTypeError(f"Invalid date format: {date_str}. Expected YYYY-MM-DD.")

parser = argparse.ArgumentParser()
parser.add_argument("-c", "--config", type=str, default="config.json",
                    help="path to configuration file")
parser.add_argument("-t", "--upload_type", type=str,
                    help="ADD/UPDATE or DELETE", required=True)
parser.add_argument("-f", "--files", type=str, nargs='+',
                    help="List of files to process [space-separated]", required=True)
parser.add_argument("--rp_start", type=validate_date, 
                    help="Start date of the reporting period in ISO format (YYYY-MM-DD)")
parser.add_argument("--rp_end", type=validate_date, 
                    help="End date of the reporting period in ISO format (YYYY-MM-DD)")

args = parser.parse_args()

# Expand wildcards
expanded_files = []
for pattern in args.files:
    expanded_files.extend(glob.glob(pattern))  # Expand each pattern

if not expanded_files:
    print("Error: No matching files found for the provided pattern(s).")
    exit(1)


max_attempts = 10
rp_start = None
rp_end = None
if args.rp_start:
    rp_start = args.rp_start
if args.rp_end:
    rp_end = args.rp_end

config = epc_cli.load_config(args.config)

t = epc_cli.request_token(config)
print()

for f in expanded_files:

    d_my_guid = epc_cli.upload_csv(t, config, f, args.upload_type, rp_start, rp_end)
    print()
    i=0
    l_guids_ok=[]
    while(i<max_attempts):
        l_guids_data_ok = epc_cli.get_upload_save_status(t, config, d_my_guid)
        #print("    Attempt: {}".format(i+1))
        print()
        if l_guids_data_ok != []:
            break
        if i > max_attempts:
            print("ERROR: exceeded maximum number of attempts")
            sys.exit()
        i+=1
        time.sleep(5)
    b = epc_cli.start_tech_validation(t, config, l_guids_data_ok)
    print()
    technicalValidationJobGroupGuid=None
    j=0
    while(j<=max_attempts):
        s = epc_cli.get_upload_timeline(t, config, l_guids_data_ok[0])
        #print("    Attempt: {}".format(j+1))
        print()
        if (len(s["timeLineSteps"]) > 0) and (s["timeLineSteps"][-1]["uploadState"] == "Tech validation successful"):
            technicalValidationJobGroupGuid=s["technicalValidationJobGroupGuid"]
            break
        if j > max_attempts:
            print("ERROR: exceeded maximum number of attempts")
            sys.exit() 
        time.sleep(10)
        j+=1
    if technicalValidationJobGroupGuid:
        epc_cli.get_csv_tech_validation(t, config, technicalValidationJobGroupGuid, f"{config["outputs"]["submission_data"]}/submissions/{l_guids_data_ok[0]}/technical_validation_report.csv")
        
 

    