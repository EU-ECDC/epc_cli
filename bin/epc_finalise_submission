#!/usr/bin/env python

import sys
sys.path.insert(0, '.')
import re
import argparse
import epc_cli
import glob
import logging
import time
import json

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s: %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

parser = argparse.ArgumentParser()
parser.add_argument("-c", "--config", type=str, default="config.json",
                    help="path to configuration file")
parser.add_argument("-evg", "--epi_validation_guid", type=str,
                    help="Epidemiological Validation GUID", required=True)
parser.add_argument("-a", "--action", type=str,
                    help="Action: [Approve|Reject]", required=True)
parser.add_argument("-r", "--reject_reason", type=str,
                    help="Message describing the reason of rejection")

args = parser.parse_args()

config_data = epc_cli.load_config(args.config)
t = None
if epc_cli.is_token_potentially_valid(config_data):
    t = epc_cli.read_token(config_data)
else:
    epc_cli.set_cryptfile_keyring(config_data["env"]["kr_path"])
    t = epc_cli.request_token(config_data)
print()

if args.action in ["Approve", "Reject"]:
    if args.reject_reason:
        ydata = epc_cli.approve_reject_submission(t, config_data, args.epi_validation_guid, args.action, args.reject_reason)
        print(f"    action: {args.action}")
        print(f"    isSuccessful: {ydata['isSuccessful']}")
        print(f"    taskCorrelationGuid: {ydata['taskCorrelationGuid']}")
    else:
        ndata = epc_cli.approve_reject_submission(t, config_data, args.epi_validation_guid, args.action)
        print(f"    action: {args.action}")
        print(f"    isSuccessful: {ndata['isSuccessful']}")
        print(f"    taskCorrelationGuid: {ndata['taskCorrelationGuid']}")
else:
    print("ERROR: Invalid action")

